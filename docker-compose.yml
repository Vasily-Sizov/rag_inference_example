services:
  # ======================================================
  # ARTEMIS BROKER (3 IN + 3 OUT очереди)
  # ======================================================
  artemis:
    image: vromero/activemq-artemis:latest
    environment:
      ARTEMIS_USERNAME: artemis
      ARTEMIS_PASSWORD: artemis
      ARTEMIS_CREATE_QUEUES: "chat.in;email.in;index.in;chat.out;email.out;index.out"
    ports:
      - "61616:61616"   # AMQP
      - "8161:8161"     # веб-консоль
    restart: unless-stopped

  # ============================
  # Redis очереди: chats, email
  # ============================
  redis:
    image: redis:7
    ports:
      - "6379:6379"
    restart: unless-stopped

  # ============================
  # OpenSearch
  # ============================
  opensearch:
    image: opensearchproject/opensearch:2.13.0
    environment:
      - discovery.type=single-node
      - DISABLE_SECURITY_PLUGIN=true
      - OPENSEARCH_JAVA_OPTS=-Xms1g -Xmx1g
    ulimits:
      memlock:
        soft: -1
        hard: -1
    ports:
      - "9200:9200"
    restart: unless-stopped

  # ============================
  # FILE SERVICE (SХК)
  # ============================
  file_service:
    build: ./file_service
    ports:
      - "9001:9001"
    volumes:
      - ./storage:/storage
    restart: unless-stopped

  # ===============================================================
  # TRANSLATOR SERVICE — сервис-переходник: слушает Artemis, 
  # маршрутизирует в Redis/Indexer, принимает результаты и пишет в Artemis
  # ===============================================================
  translator_service:
    build: ./translator_service
    environment:
      REDIS_HOST: redis
      REDIS_PORT: 6379
      QUEUE_CHATS: chats
      QUEUE_EMAIL: email
      ARTEMIS_URL: "amqp://artemis:artemis@artemis:61616"
      ARTEMIS_QUEUE_CHAT_IN: "chat.in"
      ARTEMIS_QUEUE_EMAIL_IN: "email.in"
      ARTEMIS_QUEUE_INDEX_IN: "index.in"
      ARTEMIS_QUEUE_CHAT_OUT: "chat.out"
      ARTEMIS_QUEUE_EMAIL_OUT: "email.out"
      ARTEMIS_QUEUE_INDEX_OUT: "index.out"
      INDEXER_URL: "http://indexer_service:8001/index"
    ports:
      - "8005:8005"
    depends_on:
      - redis
      - artemis
    restart: unless-stopped

  # ======================================================
  # INDEXER_SERVICE — генерирует вектора → OpenSearch, отправляет результат в translator_service
  # ======================================================
  indexer_service:
    build: ./indexer_service
    environment:
      OPENSEARCH_HOST: "http://opensearch:9200"
      FILE_SERVICE_URL: "http://file_service:9001"
      INDEX_NAME: "docs"
      TRANSLATOR_SERVICE_URL: "http://translator_service:8005/result/indexer"
    ports:
      - "8001:8001"
    depends_on:
      - opensearch
      - file_service
      - translator_service
    restart: unless-stopped

  # ======================================================
  # RAG_SERVICE — воркер, читает Redis и шлёт ответы в translator_service
  # ======================================================
  rag_service:
    build: ./rag_service
    environment:
      REDIS_HOST: redis
      OPENSEARCH_HOST: "http://opensearch:9200"
      INDEX_NAME: "docs"
      QUEUE_CHATS: chats
      QUEUE_EMAIL: email
      TRANSLATOR_SERVICE_URL: "http://translator_service:8005/result/rag"
    depends_on:
      - redis
      - opensearch
      - translator_service
    restart: unless-stopped

networks:
  default:
    name: rag_architecture_network
