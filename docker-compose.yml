version: "3.9"

services:
  # ======================================================
  # ARTEMIS BROKER (3 IN + 3 OUT очереди)
  # ======================================================
  artemis:
    image: vromero/activemq-artemis:latest
    environment:
      ARTEMIS_USERNAME: artemis
      ARTEMIS_PASSWORD: artemis
      ARTEMIS_CREATE_QUEUES: "chat.in;email.in;index.in;chat.out;email.out;index.out"
    ports:
      - "61616:61616"   # AMQP
      - "8161:8161"     # веб-консоль
    restart: unless-stopped

  # ============================
  # Redis очереди: chats, email
  # ============================
  redis:
    image: redis:7
    ports:
      - "6379:6379"
    restart: unless-stopped

  # ============================
  # OpenSearch
  # ============================
  opensearch:
    image: opensearchproject/opensearch:2.13.0
    environment:
      - discovery.type=single-node
      - DISABLE_SECURITY_PLUGIN=true
      - OPENSEARCH_JAVA_OPTS=-Xms1g -Xmx1g
    ulimits:
      memlock:
        soft: -1
        hard: -1
    ports:
      - "9200:9200"
    restart: unless-stopped

  # ============================
  # FILE SERVICE (SХК)
  # ============================
  file_service:
    build: ./file_service
    ports:
      - "9001:9001"
    volumes:
      - ./storage:/storage
    restart: unless-stopped

  # ===================================================================
  # ARTEMIS_CHAT_EMAIL — слушает chat.in + email.in и шлёт в translator
  # ===================================================================
  artemis_chat_email:
    build: ./artemis_chat_email
    environment:
      ARTEMIS_URL: "amqp://artemis:artemis@artemis:61616"
      QUEUE_CHAT: "chat.in"
      QUEUE_EMAIL: "email.in"
      TRANSLATOR_URL: "http://translator_service:8005/ingest"
    depends_on:
      - artemis
      - translator_service
    restart: unless-stopped

  # ===============================================================
  # TRANSLATOR SERVICE — маршрутизатор → Redis (chats / email)
  # ===============================================================
  translator_service:
    build: ./translator_service
    environment:
      REDIS_HOST: redis
      REDIS_PORT: 6379
      QUEUE_CHATS: chats
      QUEUE_EMAIL: email
    ports:
      - "8005:8005"
    depends_on:
      - redis
    restart: unless-stopped

  # ======================================================
  # INDEXER_STUB — генерирует вектора → OpenSearch
  # ======================================================
  indexer_stub:
    build: ./indexer_stub
    environment:
      OPENSEARCH_HOST: "http://opensearch:9200"
      FILE_SERVICE_URL: "http://file_service:9001"
      INDEX_NAME: "docs"
    ports:
      - "8001:8001"
    depends_on:
      - opensearch
      - file_service
    restart: unless-stopped

  # ======================================================================
  # ARTEMIS_INDEXER — слушает index.in и шлёт результат в index.out
  # ======================================================================
  artemis_indexer:
    build: ./artemis_indexer
    environment:
      ARTEMIS_URL: "amqp://artemis:artemis@artemis:61616"
      QUEUE_NAME: "index.in"
      INDEXER_URL: "http://indexer_stub:8001/index"
      OUT_QUEUE_NAME: "index.out"
    depends_on:
      - artemis
      - indexer_stub
    restart: unless-stopped

  # ======================================================
  # RAG_STUB — воркер, читает Redis и шлёт ответы в chat.out / email.out
  # ======================================================
  rag_stub:
    build: ./rag_stub
    environment:
      REDIS_HOST: redis
      OPENSEARCH_HOST: "http://opensearch:9200"
      INDEX_NAME: "docs"
      ARTEMIS_URL: "amqp://artemis:artemis@artemis:61616"
      CHAT_OUT_QUEUE: "chat.out"
      EMAIL_OUT_QUEUE: "email.out"
    depends_on:
      - redis
      - opensearch
      - artemis
    restart: unless-stopped

networks:
  default:
    name: rag_architecture_network
